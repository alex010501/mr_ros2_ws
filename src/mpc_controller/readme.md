## Практическое задание №3
### Управление движением ровера по траектории с помощью MPC(model predictive control)
В этой задаче мы будем управлять движением ровера по траектории с помощью метоов MPC, реализованных в специализированной библиотеке [ACADO](https://acado.github.io/)

Запуск модели и контроллера 

В корневой папке ROS workspace запускаем bash файл
```bash
sudo bash ./task3.bash
```
Запустится модель робота, а также контроллер, rqt с графиками ошибок и текущих скоростей и rviz, в котором отображается заданная (зеленым цветом), рассчетная по mpc (красными точками) траектория и текущее положение робота.
Робот движется по заданной траектории.

В этой задаче контроллер управляет как скоростью ровера, так и поворотом руля.
Контроллер реализован в виде класса [MPCController](./include/mpc_controller/mpccontroller.h).
Траектория задается в виде [списка сегментов](./include/mpc_controller/trajectory_segment.h).
Некоторые функции класса MPCController являются коллбэками на сообщения ROS:
- [on_pose](./src/mpccontroller.cpp#L167) - обновляет положение робота (подписана на топик с ground truth симулятора)
- [on_odo](./src/mpccontroller.cpp#L179) - получение одометрии робота, обновление текущей скорости.

Основная логика контроллера выполняется в функции- колбеке [таймера](./src/mpccontroller.cpp#L138). Состоит из следующих шагов:
- apply_control - отправляет желаемую скорость и желаемый угол поворота руля, рассчитанные на предыдущем шаге;
- update_robot_pose - на основе последних данных о положении робота и его скорости расчитывает положение робота к следующему срабатыванию таймера;
- update_trajectory_segment - обновляет указатель на ближайший сегмент траектории вдоль, которого движется робот;
- update_control_points - обновляет массив контрольных точек(длина control_points_num), лежащих на траектории, начиная с ближайшей к роботу. Расстояние между точками control_points_dl;
- convert_control_points - переводит координаты точек в систему координат, связанную с центром робота;
- calculate_control_coefs - рассчитывает коэфициенты полинома третьей степени, который лучшим образом описывает контрольные точки в координатах робота;
 Далее запускается MPC на вход которому подается начальноя скорость и текущий угол поворота руля, коэффициенты полинома. На выходе имеем ускорение и скорость поворота руля котрые необходимо применить, чтобы остаться на траектории с соблюдением огранияений заданных в MPC, а также оптимальная траектория, рассчитанная в MPC
 После расчета для отладки публикуются заданная траектрия - publish_trajectory, полином - publish_poly и траектория MPC - publish_mpc_trajectory. Траектории публикуются в виде облаков точек, которые отображаются в rviz. Также публикуется ошибка - расстояние до ближайшей точки траектории - publish_error

 ## Устройство MPC
 Сам механизм расчета mpc траектории реализован в класс [MPC](./include/mpc_controller/mpc.h)
 Для решения  MPC спользуется библиотека ACADO. 
 В классе определяются переменные описывающие процесс управления в типах, заданных в библиотеке. 

Далее запускается расчет, на выходе которрого получаем оптимальную траекторию в виде вектора состояний и контролов, из кторой извлекаем координаты траектории для отображения и управление на следующий шаг из первого контрола.

### Задача
Подобрать коэффициенты (параметры) MPC для устойчивого движения робота со скоростью 10 м/сек. Параметры задются в [yaml файле](./config/controller.yaml). 

